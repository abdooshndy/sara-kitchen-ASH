<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <title>Ø·Ù„Ø¨Ø§ØªÙŠ - Ù…Ø·Ø¨Ø® Ø³Ø§Ø±Ø©</title>
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
</head>

<body>
  <header class="header">
    <div class="container header-inner">
      <a href="index.html" class="logo">Ù…Ø·Ø¨Ø® Ø³Ø§Ø±Ø© ğŸ‘©â€ğŸ³</a>
      <nav class="nav">
        <a href="index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="menu.html" class="nav-link">Ø§Ù„Ù…Ù†ÙŠÙˆ</a>
        <a href="my-orders.html" class="header-link header-link--primary">Ø·Ù„Ø¨Ø§ØªÙŠ</a>
        <a href="profile.html" class="header-link">Ø­Ø³Ø§Ø¨ÙŠ</a>
        <a href="customer-login.html" class="header-link">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
        <a href="cart.html" class="header-link cart-link">
          Ø§Ù„Ø³Ù„Ø© <span id="cart-count" class="cart-badge">0</span>
        </a>
      </nav>
    </div>
  </header>

  <main class="container" style="margin-top: 2rem;">
    <h1 class="page-title">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ ğŸ“œ</h1>

    <div id="orders-container" class="orders-list">
      <div class="spinner"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="config.js"></script>
  <script src="utils.js"></script>
  <script src="toast.js"></script>
  <script src="auth-customer.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const client = window.getSupabaseClient();
      const session = await CustomerAuth.checkSession();

      if (!session) {
        document.getElementById('orders-container').innerHTML = `
                <div class="text-center" style="padding: 3rem;">
                    <p>ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.</p>
                    <a href="customer-login.html" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
                </div>
            `;
        return;
      }

      // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
      await fetchOrders(client, session.user.id);

      // Ø§Ø´ØªØ±Ø§Ùƒ Realtime
      const channel = client
        .channel('my-orders')
        .on(
          'postgres_changes',
          { event: 'UPDATE', schema: 'public', table: 'orders', filter: `user_id=eq.${session.user.id}` },
          (payload) => {
            console.log('Order updated!', payload);
            if (window.showToast) showToast(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ #${payload.new.order_code} Ø¥Ù„Ù‰ ${getStatusText(payload.new.status)} ğŸ””`, "info");
            fetchOrders(client, session.user.id);
          }
        )
        .subscribe();
    });

    async function fetchOrders(client, userId) {
      const { data: orders, error } = await client
        .from('orders')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      const container = document.getElementById('orders-container');
      container.innerHTML = '';

      if (!orders || orders.length === 0) {
        container.innerHTML = '<p class="text-center">Ù„Ù… ØªÙ‚Ù… Ø¨Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯. <a href="menu.html">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†!</a></p>';
        return;
      }

      orders.forEach(order => {
        renderOrderCard(container, order);
      });
    }

    function formatPrice(price) {
      return `${Number(price).toFixed(2)} Ø¬.Ù…`;
    }

    function renderOrderCard(container, order) {
      const date = new Date(order.created_at).toLocaleDateString('ar-EG');
      const statusClass = getStatusClass(order.status);
      const statusText = getStatusText(order.status);

      const card = document.createElement('div');
      card.className = 'order-card';
      card.style.cssText = "background: #fff; border: 1px solid #eee; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05);";

      card.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <div>
                    <strong>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #${order.order_code}</strong>
                    <div style="font-size: 0.9rem; color: #666;">${date}</div>
                </div>
                <div>
                    <span class="badge ${statusClass}">${statusText}</span>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="font-weight: bold; color: #8d4b2b;">
                    Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatPrice(order.total_amount)}
                </div>
                <button class="btn btn-sm btn-outline-primary" onclick="reorder('${order.id}', event)">Ø§Ø·Ù„Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ğŸ”„</button>
            </div>
        `;
      container.appendChild(card);
    }

    function getStatusClass(status) {
      switch (status) {
        case 'PENDING': return 'badge-warning'; // Ø£ØµÙØ±
        case 'PREPARING': return 'badge-info'; // Ø£Ø²Ø±Ù‚
        case 'READY': return 'badge-primary'; // Ù„ÙˆÙ† Ø£Ø³Ø§Ø³ÙŠ
        case 'DELIVERED': return 'badge-success'; // Ø£Ø®Ø¶Ø±
        case 'CANCELLED': return 'badge-danger'; // Ø£Ø­Ù…Ø±
        default: return '';
      }
    }

    function getStatusText(status) {
      const map = {
        'PENDING': 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±',
        'PREPARING': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±',
        'READY': 'Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØµÙŠÙ„',
        'DELIVERED': 'ØªÙ… Ø§Ù„ØªÙˆØµÙŠÙ„',
        'CANCELLED': 'Ù…Ù„ØºÙŠ'
      };
      return map[status] || status;
    }

    async function reorder(orderId, event) {
      const client = window.getSupabaseClient();
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...";

      try {
        // 1. Ø¬Ù„Ø¨ Ø£ØµÙ†Ø§Ù Ø§Ù„Ø·Ù„Ø¨
        const { data: items, error } = await client
          .from('order_items')
          .select('*')
          .eq('order_id', orderId);

        if (error) throw error;

        if (!items || items.length === 0) {
          showToast("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨", "error");
          return;
        }

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let cart = JSON.parse(localStorage.getItem('sara_cart')) || [];

        // 3. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„Ø³Ù„Ø©
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ØªØºÙŠØ±ØªØŒ Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨
        // Ø£Ùˆ Ø§Ù„Ø£ÙØ¶Ù„: Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Ø³Ø£ÙØ¹Ù„ Ø°Ù„Ùƒ Ù„Ù„Ø£Ù…Ø§Ù†)

        for (const item of items) {
          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ³Ø¹Ø±Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ
          const { data: product } = await client
            .from('products')
            .select('price, name, is_available')
            .eq('id', item.product_id)
            .single();

          if (product && product.is_available) {
            // Ø§Ù„Ø¨Ø­Ø« Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø³Ù„Ø©ØŸ
            const existingItemIndex = cart.findIndex(c => c.id === item.product_id);
            if (existingItemIndex > -1) {
              cart[existingItemIndex].quantity += item.quantity;
            } else {
              cart.push({
                id: item.product_id,
                name: product.name,
                price: product.price, // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                quantity: item.quantity,
                // Options logic is complex to restore, we might skip or assume default
                // For now, we assume basic items. If options existed, we might miss them here without complex logic.
              });
            }
          }
        }

        // 4. Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø©
        localStorage.setItem('sara_cart', JSON.stringify(cart));

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        updateCartCount();

        showToast("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³Ù„Ø©! ğŸ›’", "success");
        setTimeout(() => window.location.href = "cart.html", 1000);

      } catch (err) {
        console.error(err);
        showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø·Ù„Ø¨", "error");
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem('sara_cart')) || [];
      const count = cart.reduce((sum, item) => sum + item.quantity, 0);
      const badge = document.getElementById('cart-count');
      if (badge) badge.textContent = count;
    }
  </script>
</body>

</html>