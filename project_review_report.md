# تقرير مراجعة مشروع "مطبخ سارة للأكل البيتي"

## 1. نظرة عامة على المشروع
المشروع عبارة عن منصة ويب (Web Application) لطلب الطعام البيتي. يعتمد المشروع على تقنيات الويب الأساسية (HTML, CSS, JavaScript) في الواجهة الأمامية، ويستخدم **Supabase** كخدمة خلفية (Backend-as-a-Service) لإدارة البيانات (المنيو، الطلبات، العملاء).

**الحالة الحالية:**
- الواجهة الأمامية للعملاء (الرئيسية، المنيو، السلة، التتبع) شبه مكتملة وتعمل بشكل جيد.
- الربط مع Supabase مفعل لعرض المنيو وتسجيل الطلبات.
- لوحات التحكم (الأدمن والمندوب) موجودة كملفات HTML ولكن بدون برمجة فعلية (Logic) حتى الآن.

---

## 2. هيكلية الملفات (File Structure)

المشروع يتبع هيكلية بسيطة ومسطحة (Flat Structure):

```text
/
├── index.html              # الصفحة الرئيسية
├── menu.html               # صفحة القائمة (المنيو)
├── cart.html               # صفحة السلة
├── track.html              # صفحة تتبع الطلب
├── my-orders.html          # صفحة طلباتي (غير مفعلة برمجياً)
├── admin-login.html        # صفحة دخول الأدمن (تحتوي خطأ في المحتوى)
├── driver-login.html       # صفحة دخول المندوب
├── admin-dashboard.html    # لوحة تحكم الأدمن (تصميم فقط)
├── driver-dashboard.html   # لوحة تحكم المندوب (تصميم فقط)
├── app.js                  # ملف الجافاسكربت الرئيسي (يحتوي كل المنطق)
├── config.js               # ملف الإعدادات (Supabase Keys, App Info)
├── styles.css              # ملف التنسيقات (CSS)
├── project-config.md       # ملف توثيق للإعدادات
└── assets...               # (Images, Favicon)
```

**ملاحظات على الهيكلية:**
- **بساطة:** الهيكلية مناسبة جداً لمشروع بهذا الحجم وسهلة النشر (Deployment).
- **مركزية الكود:** الاعتماد على ملف `app.js` واحد لكل الصفحات قد يجعل الملف ضخماً مع الوقت وصعب الصيانة. يفضل تقسيمه مستقبلاً (مثلاً `admin.js`, `customer.js`).
- **خطأ في الملفات:** ملف `admin-login.html` يحتوي بداخله على كود `driver-login.html` (العنوان "دخول المندوب"). يبدو أنه تم نسخه ولم يتم تعديله.

---

## 3. تدفق البيانات (Data Flow)

### أ. عرض المنيو (Menu Display)
1.  يقوم العميل بفتح صفحة `menu.html`.
2.  يتحقق `app.js` من الصفحة الحالية.
3.  يتصل بـ **Supabase** ويجلب البيانات من جداول:
    -   `categories`: التصنيفات.
    -   `products`: المنتجات.
    -   `offers`: العروض.
4.  يتم دمج الصور (سواء روابط خارجية أو من Supabase Storage) وعرض البطاقات في الصفحة.

### ب. إدارة السلة (Cart Management)
1.  تتم إدارة السلة بالكامل في المتصفح (Client-side) باستخدام `localStorage`.
2.  مفتاح التخزين هو `sara_kitchen_cart_v1`.
3.  لا يتم إرسال بيانات السلة للسيرفر إلا عند "تأكيد الطلب".

### ج. تسجيل الطلب (Order Placement)
1.  يملأ العميل بياناته في صفحة السلة.
2.  يقوم `app.js` بالخطوات التالية:
    -   **التحقق:** التأكد من وجود أصناف وبيانات العميل.
    -   **العميل:** البحث عن العميل برقم الهاتف في جدول `customers`، وتحديث بياناته أو إنشاء عميل جديد.
    -   **رقم الطلب:** توليد رقم طلب تسلسلي (مثل S1005) عبر قراءة وتحديث جدول `settings`.
    -   **الحفظ:** إدراج الطلب في جدول `orders` والأصناف في `order_items`.
    -   **واتساب:** فتح رابط `wa.me` برسالة جاهزة تحتوي تفاصيل الطلب لإرسالها للأدمن.

### د. تتبع الطلب (Order Tracking)
1.  يدخل العميل "رقم الطلب" و "رقم الهاتف".
2.  يستعلم `app.js` من جدول `orders` في Supabase.
3.  يعرض حالة الطلب (Pending, Preparing, etc.) وتفاصيله.

---

## 4. مراجعة الكود (Code Review)

### نقاط القوة:
-   **Clean Code:** الكود مكتوب بشكل نظيف، المتغيرات مسماة بوضوح، واستخدام الدوال (Functions) مقسم بشكل منطقي.
-   **Error Handling:** استخدام `try-catch` في معظم عمليات الاتصال بقاعدة البيانات، مما يمنع توقف التطبيق عند حدوث خطأ.
-   **Config Separation:** فصل الإعدادات في `config.js` خطوة ممتازة لتسهيل التعديل دون المساس بالكود البرمجي.
-   **Responsive UI:** التنسيقات في `styles.css` حديثة وتدعم الجوال بشكل ممتاز.

### نقاط الضعف والتحسينات المطلوبة:

1.  **الأمان (Security & RLS):**
    -   الكود يعتمد على `SUPABASE_ANON_KEY` في المتصفح. هذا طبيعي، لكن يجب التأكد من إعداد **Row Level Security (RLS)** في Supabase بشكل صارم.
    -   حالياً، الكود يقوم بـ `insert` و `update` على جداول `orders` و `customers` و `settings`. إذا لم تكن سياسات RLS مضبوطة، قد يتمكن أي شخص لديه المعرفة التقنية من التلاعب بالبيانات (مثلاً تغيير رقم الطلب التالي في `settings`).

2.  **مشكلة التزامن (Concurrency):**
    -   آلية توليد رقم الطلب (`generateOrderCode` و `safelyIncrementNextOrderNumber`) تعتمد على قراءة قيمة ثم زيادتها. في حالة وجود طلبين في نفس اللحظة، قد يحصل العميلان على نفس الرقم. يفضل استخدام `Database Sequence` أو `Function` داخل Supabase لضمان عدم التكرار.

3.  **نقص المصادقة (Authentication):**
    -   صفحات الأدمن والمندوب موجودة كواجهات فقط. لا يوجد كود للتحقق من الدخول أو حماية لوحة التحكم.
    -   يجب استخدام `supabase.auth` لإدارة دخول الأدمن والمندوبين.

4.  **ملف `admin-login.html`:**
    -   يجب تصحيح محتوى هذا الملف ليعكس "دخول الأدمن" بدلاً من "دخول المندوب".

5.  **الذكاء الاصطناعي (AI):**
    -   الكود الحالي يحتوي على "Placeholder" للمساعد الذكي. يجب ربطه بـ Edge Function أو Backend للتواصل مع OpenAI API وحماية المفتاح السري.

---

## 5. التوصيات والخطوات القادمة

1.  **تصحيح الملفات:** إصلاح محتوى `admin-login.html`.
2.  **تفعيل لوحات التحكم:**
    -   برمجة منطق `admin-dashboard.html` لجلب الطلبات وعرضها.
    -   إضافة خاصية تغيير حالة الطلب (مثلاً من "قيد الانتظار" إلى "جاري التحضير").
3.  **تأمين البيانات:**
    -   مراجعة وتفعيل سياسات RLS في Supabase.
    -   نقل منطق توليد رقم الطلب إلى Supabase Database Function لضمان الموثوقية.
4.  **إضافة المصادقة:** تفعيل Supabase Auth لحماية لوحة التحكم.
5.  **تحسين تجربة المستخدم:** إضافة إشعار (Toast Notification) بدلاً من `alert()` التقليدي ليكون الشكل أكثر احترافية.

---
**الخلاصة:** المشروع مبني بأساس جيد جداً ومنظم. يحتاج فقط لاستكمال الجانب "الإداري" (لوحات التحكم) وتأمين البيانات قبل الإطلاق الرسمي.
